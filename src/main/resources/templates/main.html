<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Main</title>
</head>
<body>

<!-- 상단 네비게이션 -->
<div style="display:flex; justify-content:flex-end; padding:20px;">
    <div>
        <!-- 비로그인 사용자 -->
        <a sec:authorize="isAnonymous()" href="/login">Login</a>

        <!-- 로그인 사용자 -->
        <a sec:authorize="isAuthenticated()" href="/logout">Logout</a>
        <a sec:authorize="isAuthenticated()" th:href="@{/guestbook(userId=${#authentication.name})}" href="/guestbook">내 방명록</a>
    </div>
</div>



<!-- 중앙 검색창 영역 -->
<div style="display:flex; flex-direction:column; align-items:center; margin-top:150px;">

    <h2>Search</h2>
    
    <!-- 에러 메시지 표시 -->
    <div th:if="${errorMessage}" style="color:red; margin-bottom:20px; padding:10px; border:1px solid red; border-radius:5px; max-width:500px; text-align:center;">
        <span th:text="${errorMessage}"></span>
    </div>
    <div th:if="${param.error}" style="color:red; margin-bottom:20px; padding:10px; border:1px solid red; border-radius:5px; max-width:500px; text-align:center;">
        <span th:if="${param.error == 'invalid_video'}">존재하지 않는 비디오 ID입니다.</span>
        <span th:if="${param.error == 'db_error'}">데이터베이스 오류가 발생했습니다.</span>
        <span th:if="${param.error == 'unknown'}">오류가 발생했습니다. 다시 시도해주세요.</span>
    </div>

    <input id="searchInput"
           type="text"
           placeholder="Enter keyword or VideoID"
           style="width:400px; height:40px; font-size:18px; padding:5px;">

    <button onclick="performSearch()"
            style="margin-top:20px; width:150px; height:40px; font-size:16px;">
        Search
    </button>
</div>

<script>
// 유튜브 URL에서 VideoID 추출
function extractYouTubeId(text) {
    try {
        // URL 로 파싱 시도
        const url = new URL(text);

        // 1) watch?v=VIDEOID
        if (url.searchParams.get("v")) {
            return url.searchParams.get("v");
        }

        // 2) youtu.be/VIDEOID
        const shortMatch = url.pathname.match(/^\/([A-Za-z0-9_-]{11})$/);
        if (shortMatch) {
            return shortMatch[1];
        }

        // 3) /embed/VIDEOID
        const embedMatch = url.pathname.match(/\/embed\/([A-Za-z0-9_-]{11})/);
        if (embedMatch) {
            return embedMatch[1];
        }

        // 4) /shorts/VIDEOID
        const shortsMatch = url.pathname.match(/\/shorts\/([A-Za-z0-9_-]{11})/);
        if (shortsMatch) {
            return shortsMatch[1];
        }

    } catch (e) {
        // URL 형식이 아닐 경우 그냥 넘어감
    }

    return null;
}


// 검색 처리 함수
function performSearch() {
    const text = document.getElementById("searchInput").value.trim();

    // 영문자 11글자 → VideoID
    const videoIdPattern = /^[A-Za-z0-9_-]{11}$/;

    // 1) 순수 VideoID 형태
    if (videoIdPattern.test(text)) {
        window.location.href = "/thread?v=" + text;
        return;
    }

    // 2) 유튜브 링크 형태 → VideoID 추출
    const extractedId = extractYouTubeId(text);
    if (extractedId && videoIdPattern.test(extractedId)) {
        window.location.href = "/thread?v=" + extractedId;
        return;
    }

    // 3) 일반 검색
    window.location.href = "/search?q=" + encodeURIComponent(text);
}
</script>


</body>
</html>