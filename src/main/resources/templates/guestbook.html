<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>방명록</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .reply-section { margin-left: 30px; margin-top: 10px; padding-left: 15px; border-left: 2px solid #ddd; }
        .reply-item { padding: 8px 0; font-size: 14px; }
        .reply-form { margin-top: 10px; display: none; }
        .reply-form.active { display: block; }
    </style>
</head>
<body>

    <h1 th:text="${owner.loginId} + '님의 방명록'"></h1>
    <hr>

    <h3>남겨진 글들</h3>
    <div id="commentList">
        <p>로딩 중...</p>
    </div>
    <hr>

    <div sec:authorize="isAuthenticated()">
        <p>
            <strong>작성:</strong> 
            <input type="text" id="commentContent" placeholder="내용을 입력하세요" style="width: 300px;">
            <button onclick="writeComment()">등록</button>
        </p>
    </div>

    <div sec:authorize="isAnonymous()">
        <p>방명록을 남기려면 <a href="/login">로그인</a>이 필요합니다.</p>
    </div>
    
    <a href="/main">메인으로 가기</a>

    <script th:inline="javascript">
        /*<![CDATA[*/
        // 방명록 주인 ID (DB의 PK)
        const guestbookId = /*[[${owner.userId}]]*/ '';
        const apiBase = '/api/comments/guestbook/' + guestbookId;
        const currentLoginId = /*[[${#authentication?.name}]]*/ null;

        // 페이지 열리면 목록 불러오기
        window.onload = function() {
            loadComments();
        };

        // 목록 불러오기 함수
        async function loadComments() {
            try {
                const res = await axios.get(apiBase);
                const comments = res.data;
                const listDiv = document.getElementById('commentList');

                if (comments.length === 0) {
                    listDiv.innerHTML = '<p>아직 작성된 글이 없습니다.</p>';
                    return;
                }

                // 목록 렌더링
                listDiv.innerHTML = '';
                for (const c of comments) {
                    const commentDiv = document.createElement('div');
                    commentDiv.style.cssText = 'border-bottom: 1px solid #ccc; padding: 10px;';
                    commentDiv.id = `comment-${c.commentId}`;
                    
                    const isOwner = currentLoginId && c.loginId === currentLoginId;
                    
                    let html = `
                        <strong>${escapeHtml(c.loginId || c.userId)}</strong> 
                        <span style="font-size: small; color: gray;">
                            (${new Date(c.createdAt).toLocaleString()})
                        </span>
                    `;
                    
                    if (isOwner) {
                        html += `
                            <button onclick="editComment('${c.commentId}')" style="margin-left:10px; font-size:12px;">수정</button>
                            <button onclick="deleteComment('${c.commentId}')" style="margin-left:5px; font-size:12px;">삭제</button>
                        `;
                    }
                    
                    html += `
                        <br>
                        <div id="comment-content-${c.commentId}">
                            ${escapeHtml(c.content)}
                        </div>
                        ${currentLoginId ? `<button onclick="toggleReplyForm('${c.commentId}')" style="margin-top:5px; font-size:12px;">답글</button>` : ''}
                        <div class="reply-section" id="replies-${c.commentId}">
                            <div class="loading" style="padding:10px; font-size:12px;">답글 로딩 중...</div>
                        </div>
                        ${currentLoginId ? `
                            <div class="reply-form" id="reply-form-${c.commentId}">
                                <textarea id="reply-input-${c.commentId}" placeholder="답글을 작성하세요" style="width:100%; height:60px; margin-top:5px;"></textarea>
                                <button onclick="submitReply('${c.commentId}')" style="margin-top:5px; font-size:12px;">답글 등록</button>
                                <button onclick="toggleReplyForm('${c.commentId}')" style="margin-left:5px; font-size:12px;">취소</button>
                            </div>
                        ` : ''}
                    `;
                    
                    commentDiv.innerHTML = html;
                    listDiv.appendChild(commentDiv);
                    
                    // 수정 버튼에 현재 내용 저장
                    if (isOwner) {
                        const editBtn = commentDiv.querySelector(`button[onclick*="editComment('${c.commentId}')"]`);
                        if (editBtn) {
                            editBtn.dataset.content = c.content;
                        }
                    }
                    
                    // 대댓글 로드
                    await loadReplies(c.commentId);
                }
            } catch (err) {
                console.error(err);
                document.getElementById('commentList').innerHTML = '<p style="color:red">목록을 불러오지 못했습니다.</p>';
            }
        }

        // 댓글 등록 함수
        async function writeComment() {
            const input = document.getElementById('commentContent');
            const content = input.value.trim();

            if (!content) {
                alert('내용을 입력해주세요.');
                return;
            }

            try {
                await axios.post(apiBase, { content: content });
                alert('등록되었습니다!');
                input.value = ''; // 입력창 비우기
                loadComments();   // 목록 새로고침
            } catch (err) {
                alert('등록 실패: ' + (err.response ? err.response.data : err.message));
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 댓글 수정 함수
        async function editComment(commentId) {
            const commentDiv = document.getElementById(`comment-${commentId}`);
            if (!commentDiv) return;
            
            const editBtn = commentDiv.querySelector(`button[onclick*="editComment('${commentId}')"]`);
            const currentContent = editBtn ? editBtn.dataset.content : '';
            
            const newContent = prompt('댓글을 수정하세요:', currentContent);
            if (newContent === null || newContent.trim() === '') {
                return;
            }
            
            try {
                const response = await axios.put(`/api/comments/${commentId}`, {
                    content: newContent.trim()
                });
                alert(response.data);
                loadComments();
            } catch (err) {
                console.error('댓글 수정 실패:', err);
                const errorMsg = err.response?.data || '댓글 수정에 실패했습니다.';
                alert(errorMsg);
            }
        }
        
        // 댓글 삭제 함수
        async function deleteComment(commentId) {
            if (!confirm('정말 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await axios.delete(`/api/comments/${commentId}`);
                alert(response.data);
                loadComments();
            } catch (err) {
                console.error('댓글 삭제 실패:', err);
                alert(err.response?.data || '댓글 삭제에 실패했습니다.');
            }
        }
        
        // 대댓글 관련 함수들
        async function loadReplies(commentId) {
            try {
                const response = await axios.get(`/api/comments/${commentId}/replies`);
                const replies = response.data;
                displayReplies(commentId, replies);
            } catch (error) {
                console.error('답글 로드 실패:', error);
                const replySection = document.getElementById(`replies-${commentId}`);
                if (replySection) {
                    replySection.innerHTML = '';
                }
            }
        }
        
        function displayReplies(commentId, replies) {
            const replySection = document.getElementById(`replies-${commentId}`);
            if (!replySection) return;
            
            if (replies.length === 0) {
                replySection.innerHTML = '';
                return;
            }
            
            replySection.innerHTML = '';
            replies.forEach(reply => {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'reply-item';
                replyDiv.id = `reply-${reply.replyId}`;
                
                const isOwner = currentLoginId && reply.loginId === currentLoginId;
                
                let html = `
                    <strong style="font-size:13px;">${escapeHtml(reply.loginId || reply.userId)}</strong>
                    <small style="color:#999; font-size:11px;">${new Date(reply.createdAt).toLocaleString()}</small>
                `;
                
                if (isOwner) {
                    html += `
                        <button onclick="editReply('${reply.replyId}', '${commentId}')" style="margin-left:5px; font-size:11px;">수정</button>
                        <button onclick="deleteReply('${reply.replyId}', '${commentId}')" style="margin-left:3px; font-size:11px;">삭제</button>
                    `;
                }
                
                html += `
                    <div id="reply-content-${reply.replyId}">
                        <span style="font-size:13px;">${escapeHtml(reply.content)}</span>
                    </div>
                `;
                
                replyDiv.innerHTML = html;
                replySection.appendChild(replyDiv);
                
                if (isOwner) {
                    const editBtn = replyDiv.querySelector(`button[onclick*="editReply('${reply.replyId}')"]`);
                    if (editBtn) {
                        editBtn.dataset.content = reply.content;
                    }
                }
            });
        }
        
        function toggleReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            if (form) {
                form.classList.toggle('active');
                if (form.classList.contains('active')) {
                    document.getElementById(`reply-input-${commentId}`).focus();
                }
            }
        }
        
        async function submitReply(commentId) {
            const input = document.getElementById(`reply-input-${commentId}`);
            const content = input.value.trim();
            
            if (!content) {
                alert('답글 내용을 입력해주세요.');
                return;
            }
            
            try {
                await axios.post(`/api/comments/${commentId}/replies`, {
                    content: content
                });
                alert('답글이 등록되었습니다.');
                input.value = '';
                toggleReplyForm(commentId);
                loadReplies(commentId);
            } catch (err) {
                console.error('답글 등록 실패:', err);
                alert(err.response?.data || '답글 등록에 실패했습니다.');
            }
        }
        
        async function editReply(replyId, commentId) {
            const replyDiv = document.getElementById(`reply-${replyId}`);
            if (!replyDiv) return;
            
            const editBtn = replyDiv.querySelector(`button[onclick*="editReply('${replyId}')"]`);
            const currentContent = editBtn ? editBtn.dataset.content : '';
            
            const newContent = prompt('답글을 수정하세요:', currentContent);
            if (newContent === null || newContent.trim() === '') {
                return;
            }
            
            try {
                const response = await axios.put(`/api/comments/replies/${replyId}`, {
                    content: newContent.trim()
                });
                alert(response.data);
                loadReplies(commentId);
            } catch (err) {
                console.error('답글 수정 실패:', err);
                alert(err.response?.data || '답글 수정에 실패했습니다.');
            }
        }
        
        async function deleteReply(replyId, commentId) {
            if (!confirm('정말 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await axios.delete(`/api/comments/replies/${replyId}`);
                alert(response.data);
                loadReplies(commentId);
            } catch (err) {
                console.error('답글 삭제 실패:', err);
                alert(err.response?.data || '답글 삭제에 실패했습니다.');
            }
        }
        /*]]>*/
    </script>
</body>
</html>